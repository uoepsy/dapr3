---
title: "some things"
editor_options: 
  chunk_output_type: console
---

```{r}
#| label: setup
#| include: false

library(tidyverse)
library(patchwork)
library(lme4)
source('_theme/theme_quarto.R')
set.seed(887)
df = tibble(
  age = c(18,19,20,33,67,24,37,55,41,31),
  exercise = round(runif(10,0,7)),
  therapy = c(0,0,1,0,1,1,0,0,1,1),
  stress = age*.3 + -.7*exercise + -3*therapy  -.1*age*therapy+ rnorm(10)
)

```



## example

::::{.columns}
:::{.column width="50%"}
![](img_sandbox/caus/Slide5.PNG)
:::
:::{.column width="50%"}

:::
::::


## example - observational study

::::{.columns}
:::{.column width="50%"}
![](img_sandbox/caus/Slide6.PNG)
:::
:::{.column width="50%" .fragment}
```{r}
#| echo: false
#| fig-width: 10
#| fig-height: 3
set.seed(700)
df = tibble(
  age = runif(100,18,80),
  drug = rbinom(100,1,plogis(scale(age)*1.2)),
  BP = rnorm(100,60+1*age - 10*drug,5)
) |> mutate(drug=factor(drug))
m2 = lm(BP~age+drug,df)
p1 = ggplot(df,aes(x=drug,y=BP,col=age))+
  geom_jitter(width=.1,height=0,
              size=2,alpha=.3)+
  stat_summary(geom="pointrange",
               position=position_nudge(x=.23))

p2 = ggplot(df,aes(x=age,y=BP,col=drug))+
  geom_point(size=3,alpha=.6)+
  geom_abline(intercept=coef(m2)[1],
              slope=coef(m2)[2],
              lwd=1,col="tomato")+
  geom_abline(intercept=coef(m2)[1]+coef(m2)[3],
              slope=coef(m2)[2],
              lwd=1,col="skyblue2")
p1
```

:::{.fragment}
```{r}
#| echo: false
#| fig-width: 10
#| fig-height: 3
p2
```
:::

:::
::::



## example - randomised trial

::::{.columns}
:::{.column width="50%"}
![](img_sandbox/caus/Slide7.PNG)
:::
:::{.column width="50%" .fragment}
```{r}
#| echo: false
#| fig-width: 10
#| fig-height: 3
set.seed(62)
df = tibble(
  age = runif(100,18,80),
  drug = rbinom(100,1,.5),
  BP = rnorm(100,60+1*age - 5*drug,5)
) |> mutate(drug=factor(drug))
m2 = lm(BP~age+drug,df)
p1 = ggplot(df,aes(x=drug,y=BP,col=age))+
  geom_jitter(width=.1,height=0,
              size=2,alpha=.3)+
  stat_summary(geom="pointrange",
               position=position_nudge(x=.23))

p2 = ggplot(df,aes(x=age,y=BP,col=drug))+
  geom_point(size=3,alpha=.6)+
  geom_abline(intercept=coef(m2)[1],
              slope=coef(m2)[2],
              lwd=1,col="tomato")+
  geom_abline(intercept=coef(m2)[1]+coef(m2)[3],
              slope=coef(m2)[2],
              lwd=1,col="skyblue2")
p1
```
```{r}
#| echo: false
#| fig-width: 10
#| fig-height: 3
p2
```

:::
::::


## example - post-treatment variables

::::{.columns}
:::{.column width="50%"}
![](img_sandbox/caus/Slide8.PNG)
:::
:::{.column width="50%"}
```{r}
#| echo: false
#| fig-width: 10
#| fig-height: 3
set.seed(44)
df = tibble(
  drug = rbinom(100,1,.5),
  cholesterol = rnorm(100,-1*drug,1),
  BP = rnorm(100,120+1.2*cholesterol,2)
) |> mutate(drug=factor(drug))
m2 = lm(BP~cholesterol+drug,df)
p1 = ggplot(df,aes(x=drug,y=BP))+
  geom_jitter(width=.1,height=0,
              size=2,alpha=.3)+
  stat_summary(geom="pointrange",
               position=position_nudge(x=.23))

p2 = ggplot(df,aes(x=cholesterol,y=BP,col=drug))+
  geom_point(size=3,alpha=.6)+
  geom_abline(intercept=coef(m2)[1],
              slope=coef(m2)[2],
              lwd=1,col="tomato")+
  geom_abline(intercept=coef(m2)[1]+coef(m2)[3],
              slope=coef(m2)[2],
              lwd=1,col="skyblue2")
p1
```
```{r}
#| echo: false
#| fig-width: 10
#| fig-height: 3
p1
```


:::
::::

## example 2 - colliders

::::{.columns}
:::{.column width="50%"}
![](img_sandbox/caus/Slide9.PNG)
:::
:::{.column width="50%"}

:::
::::

## example 2 - colliders

::::{.columns}
:::{.column width="50%"}
![](img_sandbox/caus/Slide10.PNG)
:::
:::{.column width="50%"}
![](img_sandbox/caus/Slide11.PNG) 
:::
::::

- to play around with this, see  [https://colliderbias.herokuapp.com/](https://colliderbias.herokuapp.com/){target="_blank"}
