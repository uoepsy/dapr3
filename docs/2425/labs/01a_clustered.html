<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.340">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>DAPR3 - 1. Clustered Data</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script>
function toggle_visibility(id1, id2) {
var e = document.getElementById(id1);
var f = document.getElementById(id2);
e.style.display = ((e.style.display!='none') ? 'none' : 'block');
if(f.classList.contains('jk-circle-right')) {
    f.classList.add('jk-circle-down')
    f.classList.remove('jk-circle-right')
} else {
    f.classList.add('jk-circle-right')
    f.classList.remove('jk-circle-down')
}
}
</script>
<link href="site_libs/panelset-0.2.6/panelset.css" rel="stylesheet">
<script src="site_libs/panelset-0.2.6/panelset.js"></script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./01a_clustered.html">Multilevel Model Readings</a></li><li class="breadcrumb-item"><a href="./01a_clustered.html">1. Clustered Data</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">DAPR3</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Multilevel Model Readings</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01a_clustered.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">1. Clustered Data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01b_lmm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">2. Linear Mixed Models/Multi-level Models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05a_assump.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">3. Model Assumptions</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04a_ranef.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Random Effect Structures</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05b_writing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">5. Writing</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Multilevel Models Exercises</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01ex.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Week 1 Exercises: Refresher</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02ex.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Week 2 Exercises: Intro to MLM</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03ex.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Week 3 Exercises:</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04ex.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Week 4 Exercises: Nested and Crossed</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05ex.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Week 5 Exercises:</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <span class="sidebar-item-text sidebar-link text-start">
 <span class="menu-text">Factor Analysis Readings</span></span>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <span class="sidebar-item-text sidebar-link text-start">
 <span class="menu-text">Factor Analysis Exercises</span></span>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#our-starting-point" id="toc-our-starting-point" class="nav-link active" data-scroll-target="#our-starting-point">Our Starting Point</a></li>
  <li><a href="#clustered-data" id="toc-clustered-data" class="nav-link" data-scroll-target="#clustered-data">Clustered Data</a>
  <ul class="collapse">
  <li><a href="#clusters-clusters-everywhere" id="toc-clusters-clusters-everywhere" class="nav-link" data-scroll-target="#clusters-clusters-everywhere">Clusters clusters everywhere</a></li>
  <li><a href="#what-are-clusters" id="toc-what-are-clusters" class="nav-link" data-scroll-target="#what-are-clusters">What are ‘clusters’?</a></li>
  </ul></li>
  <li><a href="#working-with-clustered-data" id="toc-working-with-clustered-data" class="nav-link" data-scroll-target="#working-with-clustered-data">Working with Clustered Data</a>
  <ul class="collapse">
  <li><a href="#determining-sample-sizes" id="toc-determining-sample-sizes" class="nav-link" data-scroll-target="#determining-sample-sizes">Determining Sample Sizes</a></li>
  <li><a href="#icc---quantifying-clustering-in-an-outcome-variable" id="toc-icc---quantifying-clustering-in-an-outcome-variable" class="nav-link" data-scroll-target="#icc---quantifying-clustering-in-an-outcome-variable">ICC - Quantifying clustering in an outcome variable</a></li>
  <li><a href="#visualisations" id="toc-visualisations" class="nav-link" data-scroll-target="#visualisations">Visualisations</a></li>
  </ul></li>
  <li><a href="#information-pooled" id="toc-information-pooled" class="nav-link" data-scroll-target="#information-pooled">Information, pooled</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">1. Clustered Data</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<div class="lo">
<p>This reading:</p>
<ul>
<li>A refresher on the linear regression model<br>
</li>
<li>An introduction to clustered data</li>
<li>Working with clustered data (sample sizes, ICC, visualisations)</li>
</ul>
</div>
<section id="our-starting-point" class="level1">
<h1>Our Starting Point</h1>
<p>We’re going to start this course with our good old friend the linear regression model. The content we’re going to cover in this block can be seen as an extension of these methods, so keep in mind that the materials from previous courses you have taken will likely be very a useful resource.</p>
<div class="sticky">
<p><strong>Linear Regression</strong></p>
<p>The linear regression model is a way of expressing an outcome (or “dependent”) variable <span class="math inline">\(y\)</span> as the linear combination of various predictors <span class="math inline">\(x_1,\ ...\ ,\ x_p\)</span> (or “independent variables”).</p>
<p>We can write the linear regression model as:<br>
<span class="math display">\[
\begin{align}\\
&amp; \color{red}{y} = \color{blue}{b_0 + b_1x_1 \ + \ ... \ + \ b_px_p} \color{black}{\ + \ \varepsilon}\\
&amp; \text{Where:} \\
&amp; \epsilon \sim N(0, \sigma) \text{ independently}
\end{align}
\]</span> where the <span class="math inline">\(b\)</span>’s (sometimes written <span class="math inline">\(\beta\)</span>) are the partial associations between each predictor and the outcome. For instance, <span class="math inline">\(b_1\)</span> represents the expected change in <span class="math inline">\(y\)</span> associated with a 1 unit change in <span class="math inline">\(x_1\)</span>, while <em>holding constant</em> other independent variables <span class="math inline">\(x_2,\ ...\ ,\ x_p\)</span>.<br>
In this way, we can use the regression model to isolate the association between each predictor and the outcome from the other predictors in the model.</p>
<p>In R, we fit these models using:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lm</span>(y <span class="sc">~</span> x1 <span class="sc">+</span> x2 <span class="sc">+</span> .... xp, <span class="at">data =</span> mydata)  </span></code></pre></div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
optional: a general notation
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>If we wanted to write this more simply, we can express <span class="math inline">\(x_1\)</span> to <span class="math inline">\(x_p\)</span> as an <span class="math inline">\(n \times p\)</span> matrix (sample size <span class="math inline">\(\times\)</span> parameters), and <span class="math inline">\(b_0\)</span> to <span class="math inline">\(b_p\)</span> as a vector of coefficients: <span class="math display">\[
\begin{align}
&amp; \color{red}{\mathbf{y}} = \color{blue}{\mathbf{X b}} + \boldsymbol{\varepsilon} \\
&amp; \varepsilon \sim N(0, \sigma) \text{ independently} \\
\end{align}
\]</span> You can see below how we get between these two formulations. In the top line, we use an index <span class="math inline">\(i\)</span> to indicate that the model is fitted over a set of observations. In the middle we can see this expanded out to show the value for each individual observation on each <span class="math inline">\(y\)</span> and <span class="math inline">\(x\)</span>. Because the <span class="math inline">\(b\)</span> coefficients are fixed - they are the same for each observation <span class="math inline">\(i\)</span>, we can separate them out so that we are multiplying the <span class="math inline">\(\mathbf{X}\)</span> matrix by the vector of <span class="math inline">\(\mathbf{b}\)</span>’s (i.e.&nbsp;the formulation we see at the bottom).</p>
<p><span class="math display">\[
\begin{align} \color{red}{y_i} \;\;\;\; &amp; = \;\;\;\;\; \color{blue}{b_0 \cdot{} 1 + b_1 \cdot{} x_{1i} + ... + b_p \cdot x_{pi}} &amp; + &amp; \;\;\;\varepsilon_i \\ \qquad \\ \color{red}{\begin{bmatrix}y_1 \\ y_2 \\ y_3 \\ y_4 \\ y_5 \\ \vdots \\ y_n \end{bmatrix}} &amp; = \color{blue}{\begin{bmatrix} 1 &amp; x_{11} &amp; x_{21} &amp; \dots &amp; x_{p1} \\ 1 &amp; x_{12} &amp; x_{22} &amp;  &amp; x_{p2} \\ 1 &amp; x_{13} &amp; x_{23} &amp;  &amp; x_{p3} \\ 1 &amp; x_{14} &amp; x_{24} &amp;  &amp; x_{p4} \\ 1 &amp; x_{15} &amp; x_{25} &amp;  &amp; x_{p5} \\ \vdots &amp; \vdots &amp; \vdots &amp; \ddots &amp; \vdots \\ 1 &amp; x_{1n} &amp; x_{2n} &amp; \dots &amp; x_{pn} \end{bmatrix} \begin{bmatrix} b_0 \\ b_1 \\ b_2 \\ \vdots \\ b_p \end{bmatrix}} &amp; + &amp; \begin{bmatrix} \varepsilon_1 \\ \varepsilon_2 \\ \varepsilon_3 \\ \varepsilon_4 \\ \varepsilon_5 \\ \vdots \\ \varepsilon_n \end{bmatrix} \\ \qquad \\ \color{red}{\boldsymbol y} \;\;\;\;\; &amp; = \qquad \qquad \;\;\; \mathbf{\color{blue}{X \qquad \qquad \qquad \;\;\;\: b}} &amp; + &amp; \;\;\; \boldsymbol \varepsilon \\ \end{align}
\]</span></p>
</div>
</div>
</div>
<!-- We have seen various ways we can extend this model to capture different processes - predictors can be continuous or categorical; we can include _interactions_ (where the effect of $x_1$ on $y$ _depends_ on the level of $x_2$); and we can even extend the same model structure to model discrete outcomes (with a little trickery of using a function to link the expected value of $\color{red}{y}$ to the linear prediction $\color{blue}{b_0 + b_1(x_1) + ... + b_p(x_p)}$).  -->
</div>
<p>When we fit linear regression models, we are fitting a line (or a regression surface, when we add in more predictors), to a cloud of datapoints. The discrepancy between the fitted model and the observed data is taken up by the residuals.</p>
<p><span class="math display">\[
\begin{align}
\color{red}{y} &amp;= \color{blue}{b_0 + b_1x_1 \ + \ ... \ + \ b_px_p} \color{black}{+ \varepsilon}\\
\color{red}{\text{observed }y} &amp;= \color{blue}{\text{fitted }\hat y} \,\, \color{black}{+ \text{ residual }\hat \varepsilon}\\
\end{align}
\]</span></p>
<p>We are theorising that our model contains all the systematic relationships with our outcome variable, we assume that the residuals - the leftovers - are essentially random noise. This is the <span class="math inline">\(\epsilon \sim N(0, \sigma)\)</span> bit, which is a way of specifying our assumption that the errors are normally distributed with a mean of zero (see <a href="#fig-slr2">Figure&nbsp;1</a>).</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-slr2" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="01a_clustered_files/figure-html/fig-slr2-1.png" class="img-fluid figure-img" style="width:80.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;1: Simple linear regression model, with the systematic part of the model in blue, and residuals in red. The distributional assumption placed on the residuals is visualised by the orange normal curves - the residuals are normally distributed with a mean of zero, and this does not change across the fitted model.</figcaption>
</figure>
</div>
</div>
</div>
<p>We typically want to check our model residuals (by plotting or performing statistical tests) to determine if we have reason to believe our assumptions are violated. The easiest way to do this in R is with <code>plot(model)</code>, which provides us with a series of visuals to examine for unusual patterns and conspicuous observations.</p>
<p>When model assumptions appear problematic, then our inferential tools go out the window. While our specific point estimates for our regression coefficients are our best linear estimates for the sample that we have, our standard errors rely on the distributional assumptions of the residuals<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>. It is our standard errors that allow us to construct test statistics and compute p-values (<a href="#fig-inf1">Figure&nbsp;2</a>) and construct confidence intervals. Our assumptions underpin our ability to generalise from our specific sample to make statements about the broader population.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-inf1" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="images/sum4.png" class="img-fluid figure-img" style="width:80.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;2: inference for regression coefficients</figcaption>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Refresher: Standard Error
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Taking <strong>samples</strong> from a <strong>population</strong> involves an element of <em>randomness</em>. The mean height of 10 randomly chosen Scottish people will not be exactly equal to the mean height of the entire Scottish population. Take another sample of 10, and we get <em>another</em> mean height (<a href="#fig-se">Figure&nbsp;3</a>).</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-se" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="01a_clustered_files/figure-html/fig-se-1.png" class="img-fluid figure-img" style="width:80.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;3: Estimates from random samples vary randomly around the population parameter</figcaption>
</figure>
</div>
</div>
</div>
<p>The standard error of a statistic is the standard deviation of all the statistics we <em>might have</em> computed from samples of that size (<a href="#fig-se2">Figure&nbsp;4</a>). We can calculate a standard error using formulae (e.g.&nbsp;for a mean, the standard error is <span class="math inline">\(\frac{\sigma}{\sqrt{n}}\)</span>) but we can also use more computationally intensive approaches such as “bootstrapping” to actually generate an empirical sampling distribution of statistics which we can then summarise.</p>
<p>We use the standard error to quantify the uncertainty around our sample statistic as an estimate of the population parameter, or to construct standardised test statistics in order to perform tests against some null hypothesis.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-se2" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="01a_clustered_files/figure-html/fig-se2-1.png" class="img-fluid figure-img" style="width:80.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;4: The standard error is the standard deviation of the ‘sampling distribution’ - the distribution of sample statistics that we <em>could</em> see.</figcaption>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<p>In the face of plots (or tests) that appear to show violations of the distributional assumptions (i.e.&nbsp;our residuals appear non-normal, or variance changes across the range of the fitted model), we should always take care to ensure our model is correctly specified (interactions or other non-linear effects, if present in the data but omitted from our model, can result in assumption violations). Following this, if we continue to have problems satisfying our assumptions, there are various options that give us more flexibility when we are faced with non-normality or non-constant variance of our residuals. If you’re interested, you can read brief explanations about some of these methods <a href="00_lm_assumpt.html" target="_blank">here</a>.</p>
<p>However, there is one assumption that we are unable to identify through examining diagnostic plots for patterns, and that is our assumption of <strong>“independence”</strong>. Thinking broadly, if our observations are not independent from one another, this means that there are systematic differences in our outcome variable that our model is not capturing. This is not something that is easily ‘corrected’<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> - it is something that we want to incorporate into our model structure.</p>
<div class="sticky">
<p><strong>Independence of observations</strong></p>
<p>Individual observations in the sample are not dependent upon one another in any way. The value of one observation is not systematically related to the value of any other observation.</p>
</div>
<p>One common way in which observations are not independent can come when the data has a <em>hierarchical</em> structure - some form of <strong>clustering</strong> of observations into different groups. These groups, or ‘clusters’, could be simply something we observe, or they could be the result of how we have designed our study.</p>
<div class="divider div-transparent div-dot">

</div>
</section>
<section id="clustered-data" class="level1">
<h1>Clustered Data</h1>
<p>A common example to start thinking about clustered data is to think about conducting a study on school children. Each observation in our sample is a different child, and they come from a set of various schools (i.e.&nbsp;we might get 20 children from Dunfermline High School, 15 from Farr High School, and so on). If we ignore the clustering of children into their respective schools, we can end up reaching completely different conclusions.</p>
<p>This can be seen in <a href="#fig-egschool">Figure&nbsp;5</a> - in which each datapoint is a single child. If we consider them to be independent of one another (Left-Hand plot), then we might think there is a strong positive relationship between <code>grade</code> and <code>motivation</code>. Once we colour them by which school they belong to, we can see that the observations in the top right of the plots are all high for some other reason - because they come from the green school.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-egschool" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="01a_clustered_files/figure-html/fig-egschool-1.png" class="img-fluid figure-img" style="width:80.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;5: Observations (children) are clustered (into schools), and their outcome (grades) are dependent upon which cluster they are in. Ignoring the clustering may lead to erroneous conclusions</figcaption>
</figure>
</div>
</div>
</div>
<p>Put another way - the children are <em>not</em> independent from one another, because they tend to be more similar to other children in the same school than they are to children from a different school. Our assumption of the normal linear model that <span class="math inline">\(\varepsilon \sim N(0,\sigma)\)</span> <span class="math inline">\(\text{ independently}\)</span> is violated, because groups of residuals <em>are</em> related to one another - e.g.&nbsp;all the children from the green school have positive residuals (see residuals vs fitted plot in <a href="#fig-egschool2">Figure&nbsp;6</a>).</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-egschool2" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="01a_clustered_files/figure-html/fig-egschool2-1.png" class="img-fluid figure-img" style="width:80.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;6: Residuals vs Fitted plot from the linear model that ignores the school/children structure of the data</figcaption>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-4-contents" aria-controls="callout-4" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
the impact of non-independence on inferences
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-4" class="callout-4-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The reason that violations of our assumption of independence is problematic is that it means we are placing more confidence in our estimates than we should.</p>
<p>This is because all of our inferential tests rely on the estimated variability in our residuals <span class="math inline">\(y_i - \hat y_i\)</span>. This variability is estimated by taking the mean squared error<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>:</p>
<p><span class="math display">\[
\text{mean squared error} = \frac{\sum{(y_i - \hat y_i)^2}}{n-k-1}
\]</span> The denominator bit on the bottom is our <em>degrees of freedom</em> (where <span class="math inline">\(n\)</span> is the total sample size, <span class="math inline">\(k\)</span> is how many predictors we have in our model). This is how many <strong>independent</strong> pieces of information are available for estimating the parameters in our model.</p>
<p>In the scenario where we have, e.g.&nbsp;33 pupils clustered into 5 schools, how many independent bits of information do we have to begin with? 33? 5? somewhere in between?</p>
<p>If we assume these pupils are all independent, because of how the mean squared error is calculated, our old friend <code>lm()</code> would estimate the residual variability to be smaller than it really is. This means that on average our standard errors will be too narrow, any confidence intervals too narrow, our F statistics will be too large, and our p-values too small.</p>
<p>In essence - our inferences will all be wrong!!</p>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
optional: F and t and MSE
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The mean squared error (MSE) goes into our <span class="math inline">\(F\)</span>-statistics as they are the ratio of the mean squares associated with the model and the mean squared error <span class="math display">\[
F = \frac{\text{Mean Squares Model}}{\text{Mean Squared Error}}
\]</span></p>
<p>The MSE also goes into our standard errors for our coefficients (and so any subsequent <span class="math inline">\(t\)</span>-statistics or confidence intervals that we might calculate).<br>
<span class="math display">\[
SE(b_p) = \sqrt{  \frac{MSE}{Var(x_p) \cdot (1-R^2_{x_p|x1,...}) }}
\]</span> (Where <span class="math inline">\(R^2_{x_p|x1,...}\)</span> is the <span class="math inline">\(R^2\)</span> value of the predictor of interest <span class="math inline">\(x_p\)</span> regressed onto all other predictors).</p>
</div>
</div>
</div>
</div>
</div>
</div>
<section id="clusters-clusters-everywhere" class="level2">
<h2 class="anchored" data-anchor-id="clusters-clusters-everywhere">Clusters clusters everywhere</h2>
<p>The idea of observing “children in schools” is just one such example of clustering that we might come across. This same <em>hierarchical data structure</em> can be found in other settings, such as patients within medical practices, employees within departments, people within towns etc. These sort of groups are higher level observations that we might sample (i.e.&nbsp;I randomly sample 20 schools, and then from each school randomly sample 30 children). However, there are also lots of cases where clustered data might arise as the result of our study design. For instance, in a <strong>Repeated Measures</strong> study we have individual experimental trials clustered within participants. <strong>Longitudinal</strong> studies exhibit the same data structure but have <em>time-ordered</em> observations clustered within people.</p>
<p>In addition, we can extend this logic to think about having clusters of clusters, and clusters of cluster of clusters<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a>. <a href="#tbl-design">Table&nbsp;1</a> shows just a few examples of different levels of clustering that may arise from different types of study.</p>
<!-- Cross sectional studies are snapshots of a structure (and that structure may contain clusters); Repeated measures studies involve assessing the same person^[it doesn't have to be people, but in psychology it usually is!] multiple times across different experimental conditions/items (resulting in clusters of observation for each person);  Longitudinal studies also result in clusters of observations for each person, but there is a temporal sequence to these observations (e.g. at various ages).   -->
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="tbl-design" class="anchored">

<div id="ccbwyvqpvo" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#ccbwyvqpvo table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#ccbwyvqpvo thead, #ccbwyvqpvo tbody, #ccbwyvqpvo tfoot, #ccbwyvqpvo tr, #ccbwyvqpvo td, #ccbwyvqpvo th {
  border-style: none;
}

#ccbwyvqpvo p {
  margin: 0;
  padding: 0;
}

#ccbwyvqpvo .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#ccbwyvqpvo .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#ccbwyvqpvo .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#ccbwyvqpvo .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#ccbwyvqpvo .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#ccbwyvqpvo .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#ccbwyvqpvo .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#ccbwyvqpvo .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#ccbwyvqpvo .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#ccbwyvqpvo .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#ccbwyvqpvo .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#ccbwyvqpvo .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#ccbwyvqpvo .gt_spanner_row {
  border-bottom-style: hidden;
}

#ccbwyvqpvo .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#ccbwyvqpvo .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#ccbwyvqpvo .gt_from_md > :first-child {
  margin-top: 0;
}

#ccbwyvqpvo .gt_from_md > :last-child {
  margin-bottom: 0;
}

#ccbwyvqpvo .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#ccbwyvqpvo .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#ccbwyvqpvo .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#ccbwyvqpvo .gt_row_group_first td {
  border-top-width: 2px;
}

#ccbwyvqpvo .gt_row_group_first th {
  border-top-width: 2px;
}

#ccbwyvqpvo .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#ccbwyvqpvo .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#ccbwyvqpvo .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#ccbwyvqpvo .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#ccbwyvqpvo .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#ccbwyvqpvo .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#ccbwyvqpvo .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#ccbwyvqpvo .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#ccbwyvqpvo .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#ccbwyvqpvo .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#ccbwyvqpvo .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#ccbwyvqpvo .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#ccbwyvqpvo .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#ccbwyvqpvo .gt_left {
  text-align: left;
}

#ccbwyvqpvo .gt_center {
  text-align: center;
}

#ccbwyvqpvo .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#ccbwyvqpvo .gt_font_normal {
  font-weight: normal;
}

#ccbwyvqpvo .gt_font_bold {
  font-weight: bold;
}

#ccbwyvqpvo .gt_font_italic {
  font-style: italic;
}

#ccbwyvqpvo .gt_super {
  font-size: 65%;
}

#ccbwyvqpvo .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#ccbwyvqpvo .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#ccbwyvqpvo .gt_indent_1 {
  text-indent: 5px;
}

#ccbwyvqpvo .gt_indent_2 {
  text-indent: 10px;
}

#ccbwyvqpvo .gt_indent_3 {
  text-indent: 15px;
}

#ccbwyvqpvo .gt_indent_4 {
  text-indent: 20px;
}

#ccbwyvqpvo .gt_indent_5 {
  text-indent: 25px;
}
</style>
<table class="gt_table" data-quarto-disable-processing="false" data-quarto-bootstrap="false"><caption>Table&nbsp;1:  <p>Various different study designs will give rise to clustered data.</p> </caption>
  <thead>
    <tr class="gt_col_headings">
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1" scope="col" id=" "> </th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1" scope="col" id="Cross Sectional">Cross Sectional</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1" scope="col" id="Repeated Measures">Repeated Measures</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1" scope="col" id="Longitudinal">Longitudinal</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr><td headers=" " class="gt_row gt_left">Level n</td>
<td headers="Cross Sectional" class="gt_row gt_left">...</td>
<td headers="Repeated Measures" class="gt_row gt_left">...</td>
<td headers="Longitudinal" class="gt_row gt_left">...</td></tr>
    <tr><td headers=" " class="gt_row gt_left">...</td>
<td headers="Cross Sectional" class="gt_row gt_left">...</td>
<td headers="Repeated Measures" class="gt_row gt_left">...</td>
<td headers="Longitudinal" class="gt_row gt_left">...</td></tr>
    <tr><td headers=" " class="gt_row gt_left">Level 3</td>
<td headers="Cross Sectional" class="gt_row gt_left">School</td>
<td headers="Repeated Measures" class="gt_row gt_left">...</td>
<td headers="Longitudinal" class="gt_row gt_left">Families</td></tr>
    <tr><td headers=" " class="gt_row gt_left">Level 2</td>
<td headers="Cross Sectional" class="gt_row gt_left">Classroom</td>
<td headers="Repeated Measures" class="gt_row gt_left">Participants</td>
<td headers="Longitudinal" class="gt_row gt_left">People</td></tr>
    <tr><td headers=" " class="gt_row gt_left">Level 1 (Observations)</td>
<td headers="Cross Sectional" class="gt_row gt_left">Children</td>
<td headers="Repeated Measures" class="gt_row gt_left">Experimental Stimuli</td>
<td headers="Longitudinal" class="gt_row gt_left">Time</td></tr>
  </tbody>
  
  
</table>
</div>
</div>
</div>
</div>
<p>The common thread throughout all these designs is the hierarchy. At the lowest level of our hierarchy is the individual observed thing. For some designs, individual people might be the lowest observation level, for others, people might be the clusters (i.e.&nbsp;we have multiple data points per person).</p>
</section>
<section id="what-are-clusters" class="level2">
<h2 class="anchored" data-anchor-id="what-are-clusters">What are ‘clusters’?</h2>
<p>At the fundamental level, we are using the term ‘cluster’ here to refer to <strong>a grouping of observations.</strong> In fact, we will probably start using the terms “clusters” and “groups” interchangeably, so it’s worth taking a bit of time to try and understand the <em>kind</em> of groupings that we’re talking about (and how we think about them).</p>
<div class="sticky">
<ul>
<li>“Clusters” are just “groups”.<br>
</li>
<li>When we talk about clustered data, the groups we are discussing can be thought of as a <em>random sample of higher level units</em>.<br>
</li>
<li>More often than not, the specific group-differences are not of interest.</li>
</ul>
</div>
<p>Contrast the idea of ‘clusters’ with how we think about other sorts of groupings. In a study that looks at “how do drugs placebo/aspirin/beta-blockers influence people’s heart rate?” (<a href="#fig-clgroup">Figure&nbsp;7</a> LH plot), we can group participants into which drug they have received. But these groupings are the very groups of interest to us, and we are interested in comparing placebo with aspirin with beta-blockers. If we were to run the study again, we’ll use the same drugs (they’re not just a random sample of drugs - the x-axis of our LH plot in <a href="#fig-clgroup">Figure&nbsp;7</a> will be the same).</p>
<p>If we are interested in “what is the average grade at GCSE?”, and we have children grouped into different schools (<a href="#fig-clgroup">Figure&nbsp;7</a> RH plot), we are probably not interested in all the specific differences between grades in Broughton High School vs Gryffe High School etc. If we were to run our study again, we don’t collect data from the same set of schools. We can view these schools as ‘clusters’ - they are another source of random variation (i.e.&nbsp;not systematic variation such as the effect of a drug, but variation we see just because schools are different from one another).</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-clgroup" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="01a_clustered_files/figure-html/fig-clgroup-1.png" class="img-fluid figure-img" style="width:80.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;7: Groupings of observations may be of specific interest - e.g.&nbsp;comparing two different drugs - or may be a groupings that we have no specific interest in (e.g.&nbsp;school A is just a random school)</figcaption>
</figure>
</div>
</div>
</div>
<p>Often, while the specific clusters are not of interest, we may have research questions that are about features of those clusters, and how they relate to things at other levels. For example, we might be interested in if the type of school funding (a school-level variable) influences the grade performance (a child-level variable). The focus of this course is multilevel modelling (also known as “mixed effects modelling”), which is a regression modelling technique that allows us to explore questions such as these (and many more).<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a></p>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-5-contents" aria-controls="callout-5" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
optional “univariate”and “multivariate”
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-5" class="callout-5-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>In “univariate” statistics there is just one source of variation we are looking at explaining, which is the observation level. In psychology, our observations are often individual people, and we have variation because people are different from one another. Our studies are looking to explain this variation.</p>
<p>In “multivariate” statistics, there are more sources of variation. For the “children in schools” example: individual children are different from another, and schools are also different from one another. We also have multiple sources of variation from questionnaire scales (e.g.&nbsp;9 survey questions about anxiety), because both there is variation in scores due to both a) people varying from one another and b) the 9 questions tending to illicit different responses from one another.</p>
</div>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-6-contents" aria-controls="callout-6" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
optional: “Panel data”
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-6" class="callout-6-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>In some fields (e.g.&nbsp;economics), clustering sometimes gets referred to as ‘panel data’. This can be a nice intuitive way of thinking about it, because we think of a plot of our data being split into different panels for each cluster:</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-panel1" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="images/panel1.png" class="img-fluid figure-img" style="width:80.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;8: Panels of data</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-panel2" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="images/panel2.png" class="img-fluid figure-img" style="width:80.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;9: Panels of panels of data</figcaption>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="divider div-transparent div-dot">

</div>
</section>
</section>
<section id="working-with-clustered-data" class="level1">
<h1>Working with Clustered Data</h1>
<div class="frame">
<p><strong>SchoolMot Data</strong></p>
<p>This dataset contains information on 900 children from 30 different schools across Scotland. The data was collected as part of a study looking at whether education-related motivation is associated with school grades.<br>
All children completed an ‘education motivation’ questionnaire, and their end-of-year grade average has been recorded.</p>
<p>It is available at <a href="https://uoepsy.github.io/data/schoolmot.csv">https://uoepsy.github.io/data/schoolmot.csv</a>.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="tbl-schoolmotdict" class="anchored">

<div id="khuwsegytk" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#khuwsegytk table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#khuwsegytk thead, #khuwsegytk tbody, #khuwsegytk tfoot, #khuwsegytk tr, #khuwsegytk td, #khuwsegytk th {
  border-style: none;
}

#khuwsegytk p {
  margin: 0;
  padding: 0;
}

#khuwsegytk .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#khuwsegytk .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#khuwsegytk .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#khuwsegytk .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#khuwsegytk .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#khuwsegytk .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#khuwsegytk .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#khuwsegytk .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#khuwsegytk .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#khuwsegytk .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#khuwsegytk .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#khuwsegytk .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#khuwsegytk .gt_spanner_row {
  border-bottom-style: hidden;
}

#khuwsegytk .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#khuwsegytk .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#khuwsegytk .gt_from_md > :first-child {
  margin-top: 0;
}

#khuwsegytk .gt_from_md > :last-child {
  margin-bottom: 0;
}

#khuwsegytk .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#khuwsegytk .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#khuwsegytk .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#khuwsegytk .gt_row_group_first td {
  border-top-width: 2px;
}

#khuwsegytk .gt_row_group_first th {
  border-top-width: 2px;
}

#khuwsegytk .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#khuwsegytk .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#khuwsegytk .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#khuwsegytk .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#khuwsegytk .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#khuwsegytk .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#khuwsegytk .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#khuwsegytk .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#khuwsegytk .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#khuwsegytk .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#khuwsegytk .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#khuwsegytk .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#khuwsegytk .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#khuwsegytk .gt_left {
  text-align: left;
}

#khuwsegytk .gt_center {
  text-align: center;
}

#khuwsegytk .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#khuwsegytk .gt_font_normal {
  font-weight: normal;
}

#khuwsegytk .gt_font_bold {
  font-weight: bold;
}

#khuwsegytk .gt_font_italic {
  font-style: italic;
}

#khuwsegytk .gt_super {
  font-size: 65%;
}

#khuwsegytk .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#khuwsegytk .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#khuwsegytk .gt_indent_1 {
  text-indent: 5px;
}

#khuwsegytk .gt_indent_2 {
  text-indent: 10px;
}

#khuwsegytk .gt_indent_3 {
  text-indent: 15px;
}

#khuwsegytk .gt_indent_4 {
  text-indent: 20px;
}

#khuwsegytk .gt_indent_5 {
  text-indent: 25px;
}
</style>
<table class="gt_table" data-quarto-disable-processing="false" data-quarto-bootstrap="false"><caption>Table&nbsp;2:  <p>SchoolMot Data Dictionary. Children are clustered in Schools, with
this group-identifier visible in the schoolid column</p> </caption>
  <thead>
    <tr class="gt_col_headings">
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1" scope="col" id="variable">variable</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1" scope="col" id="description">description</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr><td headers="variable" class="gt_row gt_left">motiv</td>
<td headers="description" class="gt_row gt_left">Child's Education Motivation Score (range 0 - 10)</td></tr>
    <tr><td headers="variable" class="gt_row gt_left">funding</td>
<td headers="description" class="gt_row gt_left">Funding ('state' or 'private')</td></tr>
    <tr><td headers="variable" class="gt_row gt_left">schoolid</td>
<td headers="description" class="gt_row gt_left">Name of School that the child attends</td></tr>
    <tr><td headers="variable" class="gt_row gt_left">grade</td>
<td headers="description" class="gt_row gt_left">Child's end-of-year grade average (0-100)</td></tr>
  </tbody>
  
  
</table>
</div>
</div>
</div>
</div>
</div>
<p>In terms of the dataframes we are going to be working with, clusters are simply included in another column that contains a unique identifier for each cluster:<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a></p>
<div class="cell" data-layout-align="center">
<div class="cell-output cell-output-stdout">
<pre><code>  motiv funding              schoolid grade
1  7.74 private       Kilsyth Academy 42.42
2  3.62   state Balwearie High School 48.23
3  4.04   state Balwearie High School 17.36
4  4.63   state Balwearie High School 58.76
5  4.54 private     Stewarton Academy 70.51
6  3.89 private       Kilsyth Academy 61.54
7   ...     ...                   ...   ...</code></pre>
</div>
</div>
<p>Data in the way it is shaped just above is referred to as being in <strong>long format</strong> - we have one row for every individual lowest observation. In this example our individual observations are children, and they are clustered into schools. So our data in this long format has one row for every child. However, our data needn’t be shaped like this. We could contain the same information in a <strong>wide</strong> format.</p>
<div class="panelset">
<section id="long" class="level4 panel">
<h4 class="anchored" data-anchor-id="long">Long</h4>
<p>In long format, the individual observations are separate rows in the data. We need to have a column identifying which cluster each observation belongs to. In the example below, the individual observations are <em>people</em>, but this is not always the case. For instance, we might have multiple trials clustered within participants (in which case each individual observation is a single trial).</p>
<p>Below, we have one row per person (we can see that Emma, Umberto, Josiah, Tom and John are all on different rows), and we have a column <code>schoolid</code> that identifies what cluster they belong to (what school they attend).</p>
<div class="cell" data-layout-align="center">
<div class="cell-output cell-output-stdout">
<pre><code>                     schoolid grade
Emma    Balwearie High School    50
Umberto Balwearie High School    65
Josiah  Balwearie High School    40
..                        ...   ...
Tom           Kilsyth Academy    75
John          Kilsyth Academy    80
...                       ...   ...</code></pre>
</div>
</div>
</section>
<section id="wide" class="level4 panel">
<h4 class="anchored" data-anchor-id="wide">Wide</h4>
<p>We can express the same information in a different way. Instead of having one row per person, we could have one row per cluster, and have a column for each of the people. We can see this below - Emma, Umberto and Josiah have moved to now be all in the 1st row (for North West Community Campus) - we can see their grades (50, 65 and 40) in that row, and Tom and John are in the row for Paisley Grammar School:</p>
<div class="cell" data-layout-align="center">
<div class="cell-output cell-output-stdout">
<pre><code>                      child 1 child 2 child 3 child 4
Balwearie High School      50      65      40     ...
..                        ...     ...     ...     ...
Kilsyth Academy            75      80     ...     ...
...                       ...     ...     ...     ...</code></pre>
</div>
</div>
</section>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-7-contents" aria-controls="callout-7" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
moving between wide and long data
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-7" class="callout-7-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>One of the more confusing things to get to grips with is the idea of reshaping a dataframe.<br>
For different reasons, you might sometimes want to have data in wide, or in long format.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://www.fromthebottomoftheheap.net/assets/img/posts/tidyr-longer-wider.gif" class="img-fluid figure-img" style="width:80.0%"></p>
<figcaption class="figure-caption">Source: https://fromthebottomoftheheap.net/2019/10/25/pivoting-tidily/</figcaption>
</figure>
</div>
</div>
</div>
<p>When the data is wide, we can make it long using <code>pivot_longer()</code>. When we make data longer, we’re essentially making lots of columns into 2 longer columns. Above, in the animation, the wide variable <strong>x</strong>, <strong>y</strong> and <strong>z</strong> go into a new longer column called <strong>name</strong> that specifies which (x/y/z) it came from, and the values get put into the <strong>val</strong> column.</p>
<p>The animation takes a shortcut in the code it displays above, but you could also use <code>pivot_longer(c(x,y,z), names_to = "name", values_to = "val")</code>. To reverse this, and put it back to being wide, we tell R which columns to take the names and values <em>from</em>: <code>pivot_wider(names_from = name, values_from = val)</code>.</p>
</div>
</div>
</div>
<section id="determining-sample-sizes" class="level2">
<h2 class="anchored" data-anchor-id="determining-sample-sizes">Determining Sample Sizes</h2>
<p>One thing we are going to want to know is our sample size. Only we now have a few more questions to keep on top of. We need to know the different sample sizes at different <em>levels.</em><br>
In the description of the <strong>SchoolMot</strong> data above we are told the relevant numbers:</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">

<div id="hzqdamhsjd" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#hzqdamhsjd table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#hzqdamhsjd thead, #hzqdamhsjd tbody, #hzqdamhsjd tfoot, #hzqdamhsjd tr, #hzqdamhsjd td, #hzqdamhsjd th {
  border-style: none;
}

#hzqdamhsjd p {
  margin: 0;
  padding: 0;
}

#hzqdamhsjd .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#hzqdamhsjd .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#hzqdamhsjd .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#hzqdamhsjd .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#hzqdamhsjd .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#hzqdamhsjd .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#hzqdamhsjd .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#hzqdamhsjd .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#hzqdamhsjd .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#hzqdamhsjd .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#hzqdamhsjd .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#hzqdamhsjd .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#hzqdamhsjd .gt_spanner_row {
  border-bottom-style: hidden;
}

#hzqdamhsjd .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#hzqdamhsjd .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#hzqdamhsjd .gt_from_md > :first-child {
  margin-top: 0;
}

#hzqdamhsjd .gt_from_md > :last-child {
  margin-bottom: 0;
}

#hzqdamhsjd .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#hzqdamhsjd .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#hzqdamhsjd .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#hzqdamhsjd .gt_row_group_first td {
  border-top-width: 2px;
}

#hzqdamhsjd .gt_row_group_first th {
  border-top-width: 2px;
}

#hzqdamhsjd .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#hzqdamhsjd .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#hzqdamhsjd .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#hzqdamhsjd .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#hzqdamhsjd .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#hzqdamhsjd .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#hzqdamhsjd .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#hzqdamhsjd .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#hzqdamhsjd .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#hzqdamhsjd .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#hzqdamhsjd .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#hzqdamhsjd .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#hzqdamhsjd .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#hzqdamhsjd .gt_left {
  text-align: left;
}

#hzqdamhsjd .gt_center {
  text-align: center;
}

#hzqdamhsjd .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#hzqdamhsjd .gt_font_normal {
  font-weight: normal;
}

#hzqdamhsjd .gt_font_bold {
  font-weight: bold;
}

#hzqdamhsjd .gt_font_italic {
  font-style: italic;
}

#hzqdamhsjd .gt_super {
  font-size: 65%;
}

#hzqdamhsjd .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#hzqdamhsjd .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#hzqdamhsjd .gt_indent_1 {
  text-indent: 5px;
}

#hzqdamhsjd .gt_indent_2 {
  text-indent: 10px;
}

#hzqdamhsjd .gt_indent_3 {
  text-indent: 15px;
}

#hzqdamhsjd .gt_indent_4 {
  text-indent: 20px;
}

#hzqdamhsjd .gt_indent_5 {
  text-indent: 25px;
}
</style>
<table class="gt_table" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
  <thead>
    <tr class="gt_col_headings">
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1" scope="col" id=" "> </th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1" scope="col" id="Unit">Unit</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="Sample Size">Sample Size</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr><td headers=" " class="gt_row gt_left">Level 2</td>
<td headers="Unit" class="gt_row gt_left">School</td>
<td headers="Sample Size" class="gt_row gt_right">30</td></tr>
    <tr><td headers=" " class="gt_row gt_left">Level 1 (Observations)</td>
<td headers="Unit" class="gt_row gt_left">Children</td>
<td headers="Sample Size" class="gt_row gt_right">900</td></tr>
  </tbody>
  
  
</table>
</div>
</div>
</div>
<p>We can check this in our data:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>schoolmot <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"https://uoepsy.github.io/data/schoolmot.csv"</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co"># how many children? (how many rows in the data?)</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(schoolmot)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 900</code></pre>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># how many schools? (how many distinct values in the schoolid column?)</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">n_distinct</span>(schoolmot<span class="sc">$</span>schoolid)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 30</code></pre>
</div>
</div>
<p>Another important thing to examine when you first get hierarchical data is the number of level 1 units that belong to each level 2 unit - i.e., do we have 100 children from Calderglen High School and only 10 from Broughton High School, or do we have the same number in each?</p>
<p>We can easily count how many children are in each school by counting the number of rows for each distinct value in the school identifier column. We could then pass this to the <code>summary()</code> function to see the minimum, median, mean, maximum etc. As we can see below, in this dataset every school has data from exactly 30 children (min is the same as max):</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>schoolmot <span class="sc">|&gt;</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(schoolid) <span class="sc">|&gt;</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>()</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   schoolid               n     
 Length:30          Min.   :30  
 Class :character   1st Qu.:30  
 Mode  :character   Median :30  
                    Mean   :30  
                    3rd Qu.:30  
                    Max.   :30  </code></pre>
</div>
</div>
</section>
<section id="icc---quantifying-clustering-in-an-outcome-variable" class="level2">
<h2 class="anchored" data-anchor-id="icc---quantifying-clustering-in-an-outcome-variable">ICC - Quantifying clustering in an outcome variable</h2>
<p>The <strong>IntraClass Correlation Coefficient (ICC)</strong> is a measure of how much variation in a variable is attributable to the clustering. It is the ratio of the variance between the clusters/groups to the total variance in the variable, and is often denoted by the symbol <span class="math inline">\(\rho\)</span>:<a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a></p>
<p><span class="math display">\[
\begin{align}
ICC \; (\rho) &amp;= \frac{\sigma^2_{b}}{\sigma^2_{b} + \sigma^2_e} \\
\text{Where} &amp; \\
&amp; \sigma^2_b: \text{between-group variance} \\
&amp; \sigma^2_e: \text{within-group variance} \\  
\end{align}
\]</span></p>
<p>This is illustrated in the <a href="#fig-schooliccplot">Figure&nbsp;10</a> below, in which our continuous outcome variable (children’s grades) is on the y-axis, and we have the different groups (our set of 30 schools) across the x-axis. We can think of the “between-group variance” as the variance of the group means around the overall mean (the black dots around the horizontal black line), and the “within-group variance” as the variance of the individual observations around each group mean (each set of coloured points around their respective larger black dot):</p>
<div class="cell" data-layout-align="center">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(schoolmot, <span class="fu">aes</span>(<span class="at">x=</span>schoolid, <span class="at">y=</span>grade))<span class="sc">+</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">col=</span>schoolid),<span class="at">alpha=</span>.<span class="dv">3</span>)<span class="sc">+</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_summary</span>(<span class="at">geom =</span> <span class="st">"pointrange"</span>)<span class="sc">+</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fu">mean</span>(schoolmot<span class="sc">$</span>grade))<span class="sc">+</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_discrete</span>(<span class="at">labels=</span>abbreviate) <span class="sc">+</span> </span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x=</span><span class="fu">element_text</span>(<span class="at">angle=</span><span class="dv">90</span>))<span class="sc">+</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">col=</span><span class="st">"none"</span>)</span></code></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-schooliccplot" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="01a_clustered_files/figure-html/fig-schooliccplot-1.png" class="img-fluid figure-img" style="width:80.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;10: Variance in grades between schools. Data from <a href="https://uoepsy.github.io/data/schoolmot.csv">https://uoepsy.github.io/data/schoolmot.csv</a></figcaption>
</figure>
</div>
</div>
</div>
<p>There are various packages that allow us to calculate the ICC, and when we get to fitting multilevel models we will see how we can extract it from a fitted model.</p>
<p>In the school motivation data (visualised above), it’s estimated that 22% of the variance in grades is due to school-related differences:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ICC)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ICCbare</span>(schoolid, grade, <span class="at">data =</span> schoolmot)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.2191859</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-8-contents" aria-controls="callout-8" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
optional: calculating ICC manually
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-8" class="callout-8-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>We have equal group sizes here (there are 30 schools, each with 30 observations), which makes calculating ICC by hand a lot easier, but it’s still a bit tricky.</p>
<p>Let’s take a look at the formula for ICC:</p>
<p><span class="math display">\[
\begin{align}
ICC \; (\rho) = &amp; \frac{\sigma^2_{b}}{\sigma^2_{b} + \sigma^2_e} \\
\qquad \\
= &amp; \frac{\frac{MS_b - MS_e}{k}}{\frac{MS_b - MS_e}{k} + MS_e} \\
\qquad \\
= &amp; \frac{MS_b - MS_e}{MS_b + (k-1)MS_e} \\
\qquad \\
\qquad \\
\text{Where:} &amp; \\
k = &amp; \textrm{number of observations in each group} \\
\qquad \\
MS_b = &amp; \textrm{Mean Squares between groups} \\
= &amp; \frac{\text{Sums Squares between groups}}{df_\text{groups}}
= \frac{\sum\limits_{i=1}(\bar{y}_i - \bar{y})^2}{\textrm{n groups}-1}\\
\qquad \\
MS_e = &amp; \textrm{Mean Squares within groups} \\
= &amp; \frac{\text{Sums Squares within groups}}{df_\text{within groups}}
= \frac{\sum\limits_{i=1}\sum\limits_{j=1}(y_{ij} - \bar{y_i})^2}{\textrm{n obs}-\textrm{n groups}}\\
\end{align}
\]</span></p>
<p>So we’re going to need to calculate the grand mean of <span class="math inline">\(y\)</span>, the group means of <span class="math inline">\(y\)</span>, and then the various squared differences between group means and grand mean, and between observations and their respective group means.</p>
<p>The code below will give us a couple of new columns. The first is the overall mean of <span class="math inline">\(y\)</span>, and the second is the mean of <span class="math inline">\(y\)</span> for each group. Note that we calculate this by first using <code>group_by</code> to make the subsequent operation (the <code>mutate</code>) be applied to each group. To ensure that the grouping does not persist after this, we’ve passed it to <code>ungroup</code> at the end.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>schoolmot <span class="ot">&lt;-</span> </span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  schoolmot <span class="sc">|&gt;</span> </span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">grand_mean =</span> <span class="fu">mean</span>(grade)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(schoolid) <span class="sc">|&gt;</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">group_mean =</span> <span class="fu">mean</span>(grade)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span></code></pre></div>
</div>
<p>Now we need to create a column which is the squared differences between the observations <span class="math inline">\(y_{ij}\)</span> and the group means <span class="math inline">\(\bar{y_i}\)</span>.<br>
We also want a column which is the squared differences between the group means <span class="math inline">\(\bar{y_i}\)</span> and the overall mean <span class="math inline">\(\bar{y}\)</span>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>schoolmot <span class="ot">&lt;-</span> schoolmot <span class="sc">|&gt;</span> </span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">within =</span> (grade<span class="sc">-</span>group_mean)<span class="sc">^</span><span class="dv">2</span>,</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">between =</span> (group_mean<span class="sc">-</span>grand_mean)<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div>
</div>
<p>And then we want to sum them:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>ssbetween <span class="ot">=</span> <span class="fu">sum</span>(schoolmot<span class="sc">$</span>between)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>sswithin <span class="ot">=</span> <span class="fu">sum</span>(schoolmot<span class="sc">$</span>within)</span></code></pre></div>
</div>
<p>Finally, we divide them by the degrees of freedom. Our degrees of freedom for our between group variance <span class="math inline">\(30 \text{ groups} - 1 \text{ grand mean}=29\)</span><br>
Our degrees of freedom for our within group variance is <span class="math inline">\(900 \text{ observations} - 30 \text{ groups}=870\)</span></p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Mean Squares between</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>msb <span class="ot">=</span> ssbetween <span class="sc">/</span> (<span class="dv">30-1</span>)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Mean Squares within </span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>mse <span class="ot">=</span> sswithin <span class="sc">/</span> (<span class="dv">900-30</span>)</span></code></pre></div>
</div>
<p>And calculate the ICC!!!<br>
The 29 here is the <span class="math inline">\(k-1\)</span> in the formula above, where <span class="math inline">\(k\)</span> is the number of observations within each group.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ICC</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>(msb<span class="sc">-</span>mse) <span class="sc">/</span>(msb <span class="sc">+</span> (<span class="dv">29</span><span class="sc">*</span>mse))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.2191859</code></pre>
</div>
</div>
</div>
</div>
</div>
<p>Another way of thinking about the ICC is that it is the correlation between two randomly drawn observations from the same group. This is a bit of a tricky thing to get your head round if you try to relate it to the type of “correlation” that you are familiar with. Pearson’s correlation (e.g think about a typical scatterplot) operates on <em>pairs of observations</em> (a set of values on the x-axis and their corresponding values on the y-axis), whereas ICC operates on <em>data which is structured in groups</em>.</p>
<p>We can think of it as the average correlation between all possible pairs of observations from the same group. Suppose I pick a school, and within that pick 2 children and plot their grades against each other. I randomly pick another school, and another two children from it, and add them to the plot, and then keep doing this (<a href="#fig-icccorplot">Figure&nbsp;11</a>). The ICC is the correlation between such pairs.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-icccorplot" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="01a_clustered_files/figure-html/fig-icccorplot-1.png" class="img-fluid figure-img" style="width:60.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;11: ICC is the correlation of randomly drawn pairs from the same group</figcaption>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-9-contents" aria-controls="callout-9" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
optional: a little simulation
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-9" class="callout-9-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>We can actually do the “randomly drawn pair of observations from the same group” via simulation.<br>
The code below creates a function for us to use. Can you figure out how it works?</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>get_random_pair <span class="ot">&lt;-</span> <span class="cf">function</span>(){</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  my_school <span class="ot">=</span> <span class="fu">sample</span>(<span class="fu">unique</span>(schoolmot<span class="sc">$</span>schoolid), <span class="dv">1</span>)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  my_obs <span class="ot">=</span> <span class="fu">sample</span>(schoolmot<span class="sc">$</span>grade[schoolmot<span class="sc">$</span>schoolid <span class="sc">==</span> my_school], <span class="at">size=</span><span class="dv">2</span>)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  my_obs</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
<p>Try it out, by running it several times.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">get_random_pair</span>()</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 28.35 50.84</code></pre>
</div>
</div>
<p>Now let’s make our computer do it loads and loads of times:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># replicate is a way of making R execute the same code repeatedly, n times.</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>sims <span class="ot">&lt;-</span> <span class="fu">replicate</span>(<span class="dv">10000</span>, <span class="fu">get_random_pair</span>())</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="co"># t() is short for "transpose" and simple rotates the object 90 degrees (so rows become columns and columns become rows)</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>sims <span class="ot">&lt;-</span> <span class="fu">t</span>(sims)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(sims[,<span class="dv">1</span>], sims[,<span class="dv">2</span>])</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.2097805</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-10-contents" aria-controls="callout-10" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
optional: correlations from group-structured data
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-10" class="callout-10-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Let’s suppose we had only 2 observations in each group.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7 × 3
  cluster observation y    
* &lt;chr&gt;   &lt;chr&gt;       &lt;chr&gt;
1 group_1 1           4    
2 group_1 2           2    
3 group_2 1           4    
4 group_2 2           2    
5 group_3 1           7    
6 group_3 2           5    
7 ...     ...         ...  </code></pre>
</div>
</div>
<p><strong>The ICC for this data is 0.18.</strong></p>
<p>Now suppose we <em>reshape</em> our data so that we have one row per group, and one column for each observation to look like this:</p>
<div class="cell" data-layout-align="center">
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7 × 3
  cluster obs1  obs2 
* &lt;chr&gt;   &lt;chr&gt; &lt;chr&gt;
1 group_1 4     2    
2 group_2 4     2    
3 group_3 7     5    
4 group_4 2     7    
5 group_5 3     8    
6 group_6 6     7    
7 ...     ...   ...  </code></pre>
</div>
</div>
<p>Calculating Pearson’s correlation on those two columns yields 0.2, which isn’t quite right. It’s close, but not quite..</p>
<div class="imp">
<p>The crucial thing here is that it is completely arbitrary which observations get called “obs1” and which get called “obs2”.<br>
The data aren’t paired, they’re just random draws from a <strong>group.</strong></p>
</div>
<p>Essentially, there are lots of different combinations of “pairs” here. There are the ones we have shown above:</p>
<div class="cell" data-layout-align="center">
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7 × 3
  cluster obs1  obs2 
* &lt;chr&gt;   &lt;chr&gt; &lt;chr&gt;
1 group_1 4     2    
2 group_2 4     2    
3 group_3 7     5    
4 group_4 2     7    
5 group_5 3     8    
6 group_6 6     7    
7 ...     ...   ...  </code></pre>
</div>
</div>
<p>But we might have equally chosen any of these:</p>
<div class="panelset">
<section id="section" class="level4 panel">
<h4 class="anchored" data-anchor-id="section">…</h4>
<div class="cell" data-layout-align="center">
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7 × 3
  cluster obs1  obs2 
* &lt;chr&gt;   &lt;chr&gt; &lt;chr&gt;
1 group_1 2     4    
2 group_2 4     2    
3 group_3 7     5    
4 group_4 2     7    
5 group_5 8     3    
6 group_6 6     7    
7 ...     ...   ...  </code></pre>
</div>
</div>
</section>
<section id="section-1" class="level4 panel">
<h4 class="anchored" data-anchor-id="section-1">…</h4>
<div class="cell" data-layout-align="center">
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7 × 3
  cluster obs1  obs2 
* &lt;chr&gt;   &lt;chr&gt; &lt;chr&gt;
1 group_1 2     4    
2 group_2 2     4    
3 group_3 7     5    
4 group_4 2     7    
5 group_5 8     3    
6 group_6 6     7    
7 ...     ...   ...  </code></pre>
</div>
</div>
</section>
<section id="section-2" class="level4 panel">
<h4 class="anchored" data-anchor-id="section-2">…</h4>
<div class="cell" data-layout-align="center">
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7 × 3
  cluster obs1  obs2 
* &lt;chr&gt;   &lt;chr&gt; &lt;chr&gt;
1 group_1 2     4    
2 group_2 2     4    
3 group_3 5     7    
4 group_4 2     7    
5 group_5 3     8    
6 group_6 6     7    
7 ...     ...   ...  </code></pre>
</div>
</div>
</section>
</div>
<p>If we take the correlation of all these combinations of pairings, then we get our ICC of 0.18!</p>
<p><strong>ICC = the expected correlation of a <em>randomly drawn pair</em> of observations from the same group.</strong></p>
</div>
</div>
</div>
<div class="sticky">
<p><strong>Why ICC?</strong></p>
<p>The ICC tells us the proportion of the total variability in an outcome variable that is attributable to the differences between groups/clusters. It ranges from 0 to 1.</p>
<p>This helps us to assess the appropriateness of using a multilevel approach. If the ICC is high, it suggests that a large amount of the variance is at the cluster level (justifying the use of multilevel modeling to account for this structure).</p>
<p><strong>There are no cut-offs</strong> - the interpretation of ICC values is inherently field-specific, as what constitutes a high or low ICC depends on the nature of the outcome variable, and the hierarchical structure within a particular research context.</p>
</div>
</section>
<section id="visualisations" class="level2">
<h2 class="anchored" data-anchor-id="visualisations">Visualisations</h2>
<p>When we’re visualising data that has a hierarchical structure such as this (i.e.&nbsp;observations grouped into clusters), we need to be careful to think about what exactly we want to show. For instance, as we are interested in how motivation is associated with grades, we might make a little plot of the two variables, but this could hide the association that happens <em>within</em> a given school (see e.g. <a href="#fig-egschool">Figure&nbsp;5</a> from earlier).</p>
<p>Some useful <strong>ggplot</strong> tools here are:</p>
<ul>
<li><code>facet_wrap()</code> - make a separate little plot for each level of a grouping variable</li>
<li>the <code>group</code> aesthetic - add separate geoms (shapes) for each level of a grouping variable</li>
</ul>
<div class="panelset">
<section id="facets" class="level5 panel">
<h5 class="anchored" data-anchor-id="facets">facets</h5>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(schoolmot, <span class="fu">aes</span>(<span class="at">x=</span>motiv,<span class="at">y=</span>grade))<span class="sc">+</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>schoolid)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="01a_clustered_files/figure-html/unnamed-chunk-41-1.png" class="img-fluid figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="group" class="level5 panel">
<h5 class="anchored" data-anchor-id="group">group</h5>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(schoolmot, <span class="fu">aes</span>(<span class="at">x=</span>motiv,<span class="at">y=</span>grade,<span class="at">group=</span>schoolid))<span class="sc">+</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha=</span>.<span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method=</span>lm, <span class="at">se=</span><span class="cn">FALSE</span>)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="01a_clustered_files/figure-html/unnamed-chunk-42-1.png" class="img-fluid figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
</section>
</div>
<div class="divider div-transparent div-dot">

</div>
</section>
</section>
<section id="information-pooled" class="level1">
<h1>Information, pooled</h1>
<p>With our current toolset (linear regression), there are two avenues for us with respect to how we analyse clustered data. We can either ignore the clustering completely (and violate our assumptions), we can add the cluster-level differences in as another predictor. These reflect different ways in which we can “pool” information from across the different clusters.</p>
<div class="sticky">
<p><strong>Complete Pooling</strong></p>
<p>All information from different clusters is pooled together estimate the relevant association (make one big line).</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lm</span>(grade <span class="sc">~</span> motiv, <span class="at">data =</span> schoolmot)</span></code></pre></div>
</div>
<p>Take all the children, fit a regression line for <code>grade ~ motivation</code>.</p>
</div>
<div class="sticky">
<p><strong>No Pooling</strong></p>
<p>Information from each cluster contributes <strong>only</strong> to an estimate for that specific cluster.</p>
<p>e.g.&nbsp;</p>
<ol type="1">
<li>No Pooling - Additive Model: Estimate the effect of motivation on grades after accounting for school-specific differences in grades.:</li>
</ol>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lm</span>(grade <span class="sc">~</span> motiv <span class="sc">+</span> schoolid, <span class="at">data =</span> schoolmot)</span></code></pre></div>
</div>
<ol start="2" type="1">
<li>No Pooling - Interaction Model: Estimate school-specific differences in grades, and school-specific differences in the effect of motivation on grades. Get <em>loads</em> of coefficients that aren’t really of interest. Slightly more difficult to get out an average slope of <code>grade ~ motiv</code>, and each school contributes equally to this average (regardless of how many children we have from that school).</li>
</ol>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lm</span>(grade <span class="sc">~</span> motiv <span class="sc">*</span> schoolid, <span class="at">data =</span> schoolmot)</span></code></pre></div>
</div>
</div>
<p>Estimating the school-specific differences in our model (the no-pooling approach) is clearly better than simply ignoring them, but it does mean that we are treating the schools as if they are completely <em>independent</em> entities.</p>
<p>Suppose we had another school - School X - for which we had only <em>three</em> children’s data (<a href="#fig-borrowstrength">Figure&nbsp;12</a>). Intuitively, we don’t want to trust the line for School X as much as we trust the others (where we have 30 children’s data). In the no-pooling approach, it is only those three children from School X that contribute to the School X line. Take this further, and imagine we have only one child’s data from some School Y. In the no-pooling method, the model doesn’t learn <em>anything</em> from the other schools and cannot estimate a line for School Y.</p>
<p>What would be great is if we could <em>somehow</em> use the information from the other schools to inform our estimation of what is going on in Schools X and Y. This is what multi-level modelling achieves, <em>partially</em> pooling information across the groups, and this is where we’ll turn to next.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-borrowstrength" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="01a_clustered_files/figure-html/fig-borrowstrength-1.png" class="img-fluid figure-img" style="width:80.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;12: Blue lines show the estimated fitted values from the no-pooling approach lm(grade ~ motiv * schoolid). School X’s estimate is based on just the 3 datapoints from that school, and does not take into account any of the other schools in anyway.</figcaption>
</figure>
</div>
</div>
</div>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Why is this? It’s because the formula to calculate the standard error involves <span class="math inline">\(\sigma^2\)</span> - the variance of the residuals. If this standard deviation is not accurate (because the residuals are non-normally distributed, or because it changes across the fitted model), then this in turn affects the accuracy of the standard error of the coefficient<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>With the exception of Generalized Least Squares (an extension of Weighted Least Squares), for which we <em>can</em> actually specify a correlational structure of the residuals. As this course focuses on multilevel models, we will not cover GLS here. However, it can often be a useful method if our the nature of the dependency in our residuals is simply a nuisance thing (i.e.&nbsp;not something that has any properties which are of interest to us).<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>or “mean squares residual”<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>It’s <a href="https://en.wikipedia.org/wiki/Turtles_all_the_way_down" target="_blank">“turtles all the way down”</a><a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p>Depending on the research question and design of the study, we may be only interested in things that occur at “level 1” (the lowest observation level). While not the focus of this course, there are alternative methods (survey weighting tools, cluster robust standard errors, or generalised estimating equations) that we may use to simply “account for the nuisance clustering”.<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6"><p>Note, this is not true for a set of analytical methods called “cluster analysis”, which attempts to identify clusters that haven’t been measured/observed (or may not even ‘exist’ in any real sense of the word).<a href="#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn7"><p>although this symbol get used for lots of other correlation-y things too!<a href="#fnref7" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">© Copyright 2019-2024 <a href="https://www.ed.ac.uk/">The University of Edinburgh</a>. Site licensed under the <a href="https://www.gnu.org/licenses/agpl-3.0.en.html">GNU AGPLv3</a> license.</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>



</body></html>